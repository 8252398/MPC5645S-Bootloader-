//***************************************************************** 
//* FILE        : S_FileReceive.c
//* 
//* DESCRIPTION : This is the file to Initial the FlexCAN register
//*
//*               In some places this includes alternative register
//*               nomenclature. Comment out the unused version to
//*               match code requirements
//*               The default version is used by Freescale in code
//*               examples
//* 
//* COPYRIGHT   :(c) 2014-2020, by XueLiMan
//* 
//* VERSION     : 1.00
//* DATE        : 3 apir 2014
//* AUTHOR      : lilin 
//******************************************************************
#include "S_FileReceive.h"

/*****************************************************************/ 
/*******************  Marco define  ******************************/
/*****************************************************************/

CANReceive_Type  CANRxMsg;		//CAN½ÓÊÕÊı¾İÖ¡»º³åÇø
CANReceive_Type  CANTxMsg;		//CAN·¢ËÍÊı¾İÖ¡»º³åÇø

unsigned char TxDataBuffer[8]={0};		//CAN·¢ËÍÊı¾İ»º³åÇø
unsigned char S_FileOnelineData[128] = {0};
CANBootloaderStatus CANBootldSts;
SFileRecord SInfroRecord;
ProgramDataBuffer ProgramDataBuf;
DataBuffer	ExchangeDataBuffer;

unsigned short LowFlashSelectFlag;
unsigned char  MidFlashSelectFlag;
unsigned char  HigFlashSelectFlag;
unsigned char  EraseFlag=0;
/*****************************************************************/ 
/*****************  Funtion definition ***************************/
/*****************************************************************/
#pragma push
#pragma section code_type ".boot_flash" 
__declspec(section ".boot_flash")
//*****************************************************************
//º¯ÊıÃû  : FlexCANTxData()
//Ãè  Êö  : FlexCAN·¢ËÍº¯Êı 
//ÊäÈë²ÎÊı: CANChannel	: ´ı·¢ËÍÊı¾İµÄCANÍ¨µÀ
//		  : MBNum		: ´ı·¢ËÍµÄÊı¾İCAN±¨ÎÄ»º³åÇø
//		  :	*pData		: Ö¸Ïò´ı·¢ËÍµÄÊı¾İÊ×µØÖ·
//·µ»Ø²ÎÊı: TRUE		: ·¢ËÍ³É¹¦
//		  :	FALSE		: ·¢ËÍÊ§°Ü
//*****************************************************************
static unsigned char  FlexCANTxData(CANReceive_Type *pCANTxDatum)
{
    unsigned char cnts;
    unsigned short TimeCounts=0;
    static unsigned char datalength;

    datalength=(unsigned char)CAN_2.BUF[0].CS.B.LENGTH;;//»ñÈ¡´ı·¢ËÍÊı¾İµÄ³¤¶È
   
    if(TxInactiveFlag==CAN_2.BUF[0].CS.B.CODE)	//ÅĞ¶Ïµ±Ç°ÊÇ·ñ¿ÉÒÔ·¢ËÍÊı¾İ
    {
    	TxSuccFlg=FALSE;
    	for (cnts = 0; cnts < 8; cnts++)		//³õÊ¼»¯·¢ËÍ»º³åÇø
	    {
	        CAN_2.BUF[0].DATA.B[cnts] = 0xFF;
	    }
	    
    	for (cnts = 0; cnts < datalength; cnts++)//½«Êı¾İ×°Èë·¢ËÍ»º³åÇøµÄÊı¾İÇøÓò
	    {
	        CAN_2.BUF[0].DATA.B[cnts] = pCANTxDatum->data[cnts];
	    }
	     
    }
    CAN_2.BUF[0].CS.B.CODE=TxActiveFlag;	//ÉèÖÃ·¢ËÍ»º³åÇøÎª¼¤»î×´Ì¬£¬ÎŞÌõ¼ş·¢ËÍÊı¾İ	
	while(TxSuccFlg==FALSE)					//µÈ´ıÏàÓ¦»º³åÇø·¢ËÍÊı¾İÍê³É
	{
		TimeCounts++;						//ÑÓÊ±
		if(TimeCounts==2000)					
			return TxSuccFlg;				//ÑÓÊ±Ê±¼äµ½£¬ÒÀÈ»Ã»ÓĞ·¢ËÍÍê³É£¬Ôò·µ»Ø·¢ËÍÊ§°ÜĞÅÏ¢
	};
	CAN_2.IFRL.B.BUF00I = 1;				//Çå³ı·¢ËÍÖĞ¶Ï±êÖ¾Î»
	return TxSuccFlg;						//·µ»Ø·¢ËÍ³É¹¦ĞÅÏ¢
}
__declspec(section ".boot_flash")
//*****************************************************************
//º¯ÊıÃû  : CANStatusAcknowledge()
//Ãè  Êö  : ¿ØÖÆ°åÓëÉÏÎ»»úµÄÎÕÊÖĞÅÏ¢·¢ËÍ 
//ÊäÈë²ÎÊı: status		: µ±Ç°µÄ´«Êä×´Ì¬
//·µ»Ø²ÎÊı: ÎŞ
//*****************************************************************
void MCUStatusAcknowledge(unsigned char status)
{
	unsigned char cnts,err;
	
	for(cnts=0;cnts<8;cnts++)		//¶ÔÊı¾İ»º³åÇø³õÊ¼»¯
	{
		TxDataBuffer[cnts] = 0xFF;
	}
	CANTxMsg.datalength = 3;
	TxDataBuffer[1]=status;			//ÌîÈëÒª·¢ËÍµÄÊı¾İµ½ÏàÓ¦Êı¾İ»º³åÇø
	
	CANTxMsg.data = (unsigned char*)&TxDataBuffer[0];
	for(cnts=0;cnts<CANTxMsg.datalength;cnts++)	//½«Êı¾İÖ¡·ÅÈë·¢ËÍ»º³åÇø
	{
		CANTxMsg.data[cnts]=*(&TxDataBuffer[cnts]);
	}
	err=FlexCANTxData(&CANTxMsg);		//ÅĞ¶ÏÊÇ·ñ·¢ËÍ³É¹¦
}
__declspec(section ".boot_flash")
//*****************************************************************
//º¯ÊıÃû  : CANWorkStatusSet()
//Ãè  Êö  : ¿ØÖÆ°åÓëÉÏÎ»»úµÄÎÕÊÖĞÅÏ¢ÉèÖÃ
//ÊäÈë²ÎÊı: status		: ĞèÒªÉèÖÃµÄ×´Ì¬
//·µ»Ø²ÎÊı: ÎŞ
//*****************************************************************
static void CANWorkStatusSet(unsigned char status)
{
	MCUBootldState=status;
}
__declspec(section ".boot_flash")
//*****************************************************************
//º¯ÊıÃû  : CanWorkStatusGet()
//Ãè  Êö  : È¡¿ØÖÆ°åÓëÉÏÎ»»úµÄCANÏß×´Ì¬
//ÊäÈë²ÎÊı: ÎŞ
//·µ»Ø²ÎÊı: µ±Ç°CANÏßµÄ×´Ì¬
//*****************************************************************
unsigned char CanWorkStatusGet(void)
{
    return MCUBootldState;
}
__declspec(section ".boot_flash")
//*****************************************************************
//º¯ÊıÃû  : CAN_SRecrod_RxISR()
//Ãè  Êö  : CAN½ÓÊÕºÍ·¢ËÍ´¦ÀíÖĞ¶Ïº¯Êı
//ÊäÈë²ÎÊı: ÎŞ
//·µ»Ø²ÎÊı: ÎŞ
//*****************************************************************
void CAN_SRecrod_RxISR(void)
{
	unsigned char cnts;
	uint32_t FlagWord;
	
		
	if(CAN_2.IFRL.B.BUF04I)						//ÅĞ¶Ï½ÓÊÕÖĞ¶Ï±êÖ¾Î»
	{
		FlagWord=CAN_2.BUF[04].CS.R;
		
		for(cnts=0;cnts<10;cnts++) NOP();
		if(!CAN_2.BUF[04].CS.B.IDE)				//ÅĞ¶ÏÊÇ·ñÎªËùĞèÒªµÄÀ©Õ¹Ö¡¸ñÊ½
		{
			CANRxMsg.datalength=(unsigned char)CAN_2.BUF[04].CS.B.LENGTH; //µÃµ½½ÓÊÕµ½µÄÊı¾İ³¤¶È
			CANRxMsg.data=(unsigned char*)&CAN_2.BUF[04].DATA.B[0];		  //½«½ÓÊÕÊı¾İµÄ´æ·ÅÖ¸ÕëÖ¸Ïò½ÓÊÕ»º³åÇøµÄÊı¾İÊ×µØÖ·

			if(CANRxMsg.MsgID==0x200)				//ÅĞ¶ÏÊÇ·ñÊÇĞèÒªµÄMessageID
			{
				for(cnts=0;cnts<CANRxMsg.datalength;cnts++)  //È¡»Ø½ÓÊÕµ½µÄÊı¾İĞÅÏ¢
				{
					CANRxMsg.data[cnts]=CAN_2.BUF[04].DATA.B[cnts];
				}
			}
			CAN_2.BUF[04].CS.B.CODE=0x04;
		}
		CANRxNewFram = TRUE;
		FlagWord=CAN_2.TIMER.R;
		CAN_2.IFRL.B.BUF04I=TRUE;
		for(cnts=0;cnts<10;cnts++) NOP();
	}
}
__declspec(section ".boot_flash")
//*****************************************************************
//º¯ÊıÃû  : CAN_0_ERR_ISR()
//Ãè  Êö  : CAN´íÎóÖĞ¶Ï´¦Àíº¯Êı
//ÊäÈë²ÎÊı: ÎŞ
//·µ»Ø²ÎÊı: ÎŞ
//*****************************************************************
void CAN_2_ERR_ISR(void)
{
	CAN_2.ESR.R=0XFFFF;
}
__declspec(section ".boot_flash")
//*****************************************************************
//º¯ÊıÃû  : CAN_SRecrod_TxISR()
//Ãè  Êö  : CAN·¢ËÍÖĞ¶Ï´¦Àíº¯Êı
//ÊäÈë²ÎÊı: ÎŞ
//·µ»Ø²ÎÊı: ÎŞ
//*****************************************************************
void CAN_SRecrod_TxISR(void)
{
	if(CAN_2.IFRL.B.BUF00I == 1)
	{
		CAN_2.IFRL.B.BUF00I = 1;	//Çå³şÖĞ¶Ï±êÖ¾Î»
		TxSuccFlg=TRUE;				//ÖÃÎ»·¢ËÍ³É¹¦±êÖ¾		
	}
	
}
__declspec(section ".boot_flash")
//*****************************************************************
//º¯ÊıÃû  : CANBootloader_Analysis()
//Ãè  Êö  : ¶Ô½ÓÊÕµ½µÄÊı¾İ½øĞĞ·ÖÎö´¦Àí
//ÊäÈë²ÎÊı: ÎŞ
//·µ»Ø²ÎÊı: ÎŞ
//*****************************************************************
void CANBootloader_Analysis(void)
{
	unsigned char cnts,err;
	unsigned char ProcFlag;
	static unsigned char OutBootloaderFlag=0;
	static unsigned char pSDataNum=0;
	static SFileRecord SrcdDatum;
	
	CANRxNewFram = FALSE;						//Çå³ıCAN½ÓÊÕµ½ĞÂÊı¾İµÄ±êÖ¾Î»
	if(MCUBusyFlg)
	{
		if(CANRxMsg.data[0]!=DOWN_OUTBOOT_CMD)	//Èç¹ûMCU»¹ÔÚ´¦ÀíÉÏÒ»´ÎµÄÃüÁî£¬Ôò·µ»ØMCUÃ¦×´Ì¬
		{
			MCUStatusAcknowledge(UP_BUSY);
			return;
		}		
	}
	switch(CANRxMsg.data[0])					//½âÎöÊÕµ½µÄÊı¾İÖ¡µÚÒ»Ö¡
	{
		MCUBusyFlg=TRUE;
		case DOWN_INBOOTSUC_CMD:				//ÊÇ·ñÎªÉÏÎ»»úÁ¬½ÓÖ¸Áî
		{
			NOP();
			NOP();
			pSDataNum=0;

			MCUStatusAcknowledge(UP_INBOOT_SUC);//ÉèÖÃCANÁ¬½Ó×´Ì¬
			MCUBusyFlg=FALSE;					//Çå³ıµ±Ç°MCUÃ¦×´Ì¬
		
			CANWorkStatusSet(STA_LINKED);		//ÉèÖÃMCUÍ¬ÉÏÎ»»úµÄÁ¬½Ó×´Ì¬ÎªÁ¬½Ó³É¹¦±êÖ¾
			break;
		}
		case DOWN_ERASE_CMD:					//ÊÕµ½ÉÏÎ»»úµÄ²Á³ıFlashÖ¸Áî
		{
			 MCUStatusAcknowledge(UP_GETERASECMD);
			 if(!EraseFlag) 
			 {
			 	LowFlashSelectFlag=CANRxMsg.data[6];
			 	LowFlashSelectFlag=(unsigned short)((LowFlashSelectFlag<<8)|CANRxMsg.data[7]);
			 	MidFlashSelectFlag=CANRxMsg.data[5];
				HigFlashSelectFlag=CANRxMsg.data[4];
				if((CANRxMsg.data[7]&0x01)||(CANRxMsg.data[7]&0x02))
				{
					EraseFlag=0;
					MCUStatusAcknowledge(UP_ERASEBOOTAREA_ERR);
				}
				else
				{
					EraseFlag++;
					Erase_Flash();   //²Á³ıFlash
					ProgramDataBuf.status=ProgramDataNotReady;
    
				    ExchangeDataBuffer.status=DataBufferEmpty;
				    ExchangeDataBuffer.addr=0;
				    ExchangeDataBuffer.data=0;
				   
					if(EraseFlagStatus==EraseSuce)//ÅĞ¶ÏMCUÊÇ·ñÒÑ¾­¶ÔFlash½øĞĞ¹ı²Á³ı²Ù×÷£¬Ã»ÓĞÔò½øĞĞFlash²Á³ı
	                {
	                	MCUStatusAcknowledge(UP_ERASE_SUC);
	                	EraseFlag=0;
	                }
	                	
	                else if(EraseFlagStatus==EraseFail)
	                {
	                	MCUStatusAcknowledge(UP_ERASEERR);
	                	EraseFlag=0;
	                }	
				}			 	
			 }
			 else
			 {
			    MCUStatusAcknowledge(UP_BUSY);
			 }
			 break;
		}
		case DOWN_LINE_END:						//ÊÕµ½ÉÏÎ»»ú´«ËÍÍêÒ»ĞĞÊı¾İµÄÖ¸Áî
		{
			ProcFlag=S19DataConvert(&S_FileOnelineData[0], &SInfroRecord);//¶ÔÊÕµ½µÄÕûĞĞÊı¾İ½øĞĞ´¦Àí
			pSDataNum=0;
			
			 
			if (ProcFlag == SPASS)			//¼ìÑéĞ£ÑéÊÇ·ñ³É¹¦£
			{
				while(SInfroRecord.status!=LineDataEnd)
                {
                	DoubleWordProgramSytleProcess(&ExchangeDataBuffer,&SInfroRecord,&ProgramDataBuf);
                	if(ProgramDataBuf.status==ProgramDataReady)
                	{
                		if(ProgramDataBuf.addr>=APP_ENRTY_ADDR)
                		{
			                CAN_2.MCR.B.MDIS = 1;
			                for(cnts=0;cnts<20;cnts++)
			                {
			                	NOP();
			                }
			                err=(unsigned char)FlashProgramer(&ProgramDataBuf);
			                for(cnts=0;cnts<20;cnts++)
			                {
			                	NOP();
			                }
			                CAN_2.MCR.B.MDIS = 0;
			                if(err==ProFail)  
			                {
				            	MCUStatusAcknowledge(UP_FLASH_ERR);
				            	EraseFlag=0;
				            	return;
			                }
                		}
                		else
                		{
				            if(SInfroRecord.status==LineDataEnd)
				            	MCUStatusAcknowledge(UP_PROONELINE_SUC);
				            return;
                		}
                	}
                }
                FlashBlkRead(SrcdDatum.data, SInfroRecord.addr, SInfroRecord.datalen);//¶ÁÈ¡Ğ´ÈëFlashÖĞµÄÊı¾İ
                
                for (cnts = 0; cnts < SInfroRecord.datalen; cnts++)  //±È½ÏÊÕµ½µÄÊı¾İÓëĞ´ÈëµÄÊı¾İÊÇ·ñÒ»ÖÂ
	            {
	                if (SrcdDatum.data[cnts] != SInfroRecord.data[cnts])
	                {
						MCUStatusAcknowledge(UP_FLASH_ERR);
						EraseFlag=0;
	                    return;
	                }
	            }
	        	MCUStatusAcknowledge(UP_PROONELINE_SUC);
			}
     
            else if (ProcFlag == SERR)
            {
            	MCUStatusAcknowledge(UP_DOWN_ERR); //Ğ£Ñé²»³É¹¦£¬Ôò·µ»Ø´íÎóĞÅÏ¢
            	MCUBusyFlg=FALSE;				   //Çå³ıµ±Ç°MCUÃ¦×´Ì¬	
            } 
            else if (ProcFlag == SInvalid)
            {
            	MCUStatusAcknowledge(UP_DOWN_ERR); //Ğ£Ñé²»³É¹¦£¬Ôò·µ»Ø´íÎóĞÅÏ¢
            	MCUBusyFlg=FALSE;				  //Çå³ıµ±Ç°MCUÃ¦×´Ì¬
            }  
            else
            {
            	MCUStatusAcknowledge(UP_PROONELINE_SUC); //ÉèÖÃÍ¨ĞÅ×´Ì¬
            	MCUBusyFlg=FALSE;						//Çå³ıµ±Ç°MCUÃ¦×´Ì¬
            }  
            break;
		}
		case DOWN_FILE_END:    					//ÊÕµ½ÎÄ¼ş´«ÊäÍê³ÉÖ¸Áî
        {
            if(ExchangeDataBuffer.status==DataBufferFull)
            {
            	ProgramDataBuf.status=ProgramDataReady;
            	ProgramDataBuf.addr=ExchangeDataBuffer.addr;
            	ProgramDataBuf.data[0]=ExchangeDataBuffer.data;
            	ProgramDataBuf.data[1]=0x00;
            	
            	if(ProgramDataBuf.status==ProgramDataReady)
            	{
            		if(ProgramDataBuf.addr>=APP_ENRTY_ADDR)
            		{
            			err=(unsigned char)FlashProgramer(&ProgramDataBuf);
		                NOP();
		                if(err==ProFail)  
		                {
			            	MCUStatusAcknowledge(UP_FLASH_ERR);
			            	EraseFlag=0;
			            	return;
		                }
            		}
            	}
            }
            MCUStatusAcknowledge(UP_PRGEND);	//ÉèÖÃÍ¨ĞÅ×´Ì¬
            MCUBusyFlg=FALSE;					//Çå³ıµ±Ç°MCUÃ¦×´Ì¬
            CANWorkStatusSet(STA_PRGEND);		
            break;
        }
        case DOWN_OUTBOOT_CMD:
        {
        	if((CANRxMsg.data[7]==0x80)&&(OutBootloaderFlag==0))
        	{
        		if(CanWorkStatusGet()==STA_PRGEND)
	        	{
	        		MCUStatusAcknowledge(UP_OUTBL_SUC);	 //ÉèÖÃÍ¨ĞÅ×´Ì¬
	        		CopyFlashDataToRAM((uint32_t*)EraseSetEnterBootFlagFlash,(uint32_t*)RAM_ADDR_ERASE_FLASH,Length_copy_ram);//½«ÖĞ¶Ïº¯Êı¸´ÖÆµ½RAMÇøÔËĞĞ
        			(*(APPFunction)RAM_ADDR_ERASE_FLASH)();
	        		//INTC.MCR.B.HVEN = 1; 			 	 //½ûÖ¹ÖĞ¶Ï
					CAN_2.MCR.B.MDIS = 1;          		 //½ûÖ¹CAN
					DlyS_Ms(100);
			        (*(APPFunction)APP_ENRTY_ADDR)();    //Ìø×ªµ½Ó¦ÓÃ³ÌĞò
			        for(;;)
			        ;
	        	}
	        	else
	        	{
	        		MCUStatusAcknowledge(UP_PRO_NO_END_ERR);
	        		OutBootloaderFlag++;
	        	}
        	}
        	else if((CANRxMsg.data[7]==0xA0)&&(OutBootloaderFlag==1))
        	{
        		if(OutBootloaderFlag)
        		{
        			OutBootloaderFlag=0;
        			MCUStatusAcknowledge(UP_OUTBL_SUC);	 //ÉèÖÃÍ¨ĞÅ×´Ì¬
        			CopyFlashDataToRAM((uint32_t*)EraseSetEnterBootFlagFlash,(uint32_t*)RAM_ADDR_ERASE_FLASH,Length_copy_ram);//½«ÖĞ¶Ïº¯Êı¸´ÖÆµ½RAMÇøÔËĞĞ
        			(*(APPFunction)RAM_ADDR_ERASE_FLASH)();
	        		//INTC.MCR.B.HVEN = 1; 			 	 //½ûÖ¹ÖĞ¶Ï
					CAN_2.MCR.B.MDIS = 1;          		 //½ûÖ¹CAN
					DlyS_Ms(100);
			        (*(APPFunction)APP_ENRTY_ADDR)();    //Ìø×ªµ½Ó¦ÓÃ³ÌĞò
			        for(;;)
			        ;
        		}	
        	}
        	else if(CANRxMsg.data[7]==0xF0)
        	{
        		OutBootloaderFlag=0;
        		MCUStatusAcknowledge(UP_CANCELINBOOT);
        	}
        	
        	break;
        }
        default:               
        {
            if (CanWorkStatusGet() == STA_LINKED)//½ÓÊÕµ½µÄÎª´¿Êı¾İÊ±
            {
                for (cnts = 0; cnts < CANRxMsg.datalength; cnts++) 
                {
                    S_FileOnelineData[pSDataNum++] = CANRxMsg.data[cnts];  //½«Êı¾İ´æÈë»º³åÇø
                }
                MCUBusyFlg=FALSE;				//Çå³ıµ±Ç°MCUÃ¦×´Ì¬
            }
            break;
        }
	}
}
#pragma pop